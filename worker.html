<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>Job Joint — Worker Dashboard</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <style> body { font-family: Inter, system-ui, -apple-system, 'Segoe UI', Roboto, 'Helvetica Neue', Arial; } .muted{ color:#6b7280 } </style>
</head>
<body class="bg-slate-50 min-h-screen">
  <header class="bg-white shadow-sm">
    <div class="max-w-6xl mx-auto px-6 py-4 flex justify-between items-center">
      <div class="flex items-center gap-3">
        <div class="w-10 h-10 rounded bg-blue-600 text-white flex items-center justify-center font-bold">JJ</div>
        <div>
          <div class="text-lg font-semibold">Job Joint</div>
          <div class="text-xs muted">Worker Dashboard</div>
        </div>
      </div>
      <div class="flex items-center gap-4">
        <div id="worker-name" class="muted text-sm"></div>
        <button id="btn-logout" class="px-4 py-2 rounded border">Logout</button>
      </div>
    </div>
  </header>

  <main class="max-w-6xl mx-auto px-6 py-8 grid grid-cols-1 lg:grid-cols-4 gap-6">
    <aside class="lg:col-span-1 bg-white rounded-2xl shadow p-6">
      <div class="font-semibold mb-2">Filters</div>
      <select id="filter-category" class="w-full p-2 border rounded mb-3">
        <option value="">All categories</option>
        <option>Plumbing</option>
        <option>Electrician</option>
        <option>Carpentry</option>
        <option>Home Cleaning</option>
      </select>
      <button id="btn-available" class="w-full px-4 py-2 rounded bg-blue-600 text-white">Show Available Jobs</button>
      <div class="mt-4 muted text-sm">Accept jobs to let the client know you will handle the request.</div>
    </aside>

    <section class="lg:col-span-3 space-y-6">
      <div class="flex items-center justify-between">
        <h2 class="text-xl font-semibold">Available Jobs</h2>
        <div class="muted text-sm">Click a card to accept</div>
      </div>

      <div id="jobs-grid" class="grid gap-4"></div>

      <div id="my-work-section" class="pt-6">
        <h3 class="font-semibold">My Accepted Jobs</h3>
        <div id="accepted-list" class="mt-3 grid gap-3"></div>
      </div>
    </section>
  </main>

  <!-- View/Accept Modal -->
  <div id="job-modal" class="fixed inset-0 bg-black bg-opacity-40 hidden items-center justify-center p-4">
    <div class="bg-white rounded-2xl w-full max-w-2xl p-6">
      <div class="flex justify-between items-center">
        <h3 id="modal-title" class="text-lg font-semibold">Job</h3>
        <button id="job-close" class="text-muted">✕</button>
      </div>
      <div id="modal-body" class="mt-3"></div>
      <div class="flex justify-end gap-3 mt-4">
        <button id="job-cancel" class="px-4 py-2 rounded border">Close</button>
        <button id="job-accept" class="px-4 py-2 rounded bg-blue-600 text-white">Accept Job</button>
      </div>
    </div>
  </div>

  <script type="module">
    import { initializeApp } from 'https://www.gstatic.com/firebasejs/10.13.1/firebase-app.js';
    import { getAuth, signOut, onAuthStateChanged } from 'https://www.gstatic.com/firebasejs/10.13.1/firebase-auth.js';
    import { getFirestore, collection, query, where, orderBy, onSnapshot, updateDoc, doc } from 'https://www.gstatic.com/firebasejs/10.13.1/firebase-firestore.js';

    const firebaseConfig = {
      apiKey: "AIzaSyAWAcXMSOt64SvgCjIS5jB5eebE4aqU1UA",
      authDomain: "jobjoint-59c4d.firebaseapp.com",
      projectId: "jobjoint-59c4d",
      storageBucket: "jobjoint-59c4d.firebasestorage.app",
      messagingSenderId: "599272153203",
      appId: "1:599272153203:web:730ec9dfdc8e74fbc98a06",
      measurementId: "G-JFKMS22GTF"
    };

    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db = getFirestore(app);

    const jobsGrid = document.getElementById('jobs-grid');
    const acceptedList = document.getElementById('accepted-list');
    const btnLogout = document.getElementById('btn-logout');
    const workerNameEl = document.getElementById('worker-name');
    const filterCategory = document.getElementById('filter-category');
    const btnAvailable = document.getElementById('btn-available');

    const jobModal = document.getElementById('job-modal');
    const jobClose = document.getElementById('job-close');
    const jobCancel = document.getElementById('job-cancel');
    const jobAccept = document.getElementById('job-accept');
    const modalTitle = document.getElementById('modal-title');
    const modalBody = document.getElementById('modal-body');

    let currentUser = null;
    let myProfile = null;
    let chosenJob = null;
    let unsubAvailable = null;
    let unsubAccepted = null;

    onAuthStateChanged(auth, async (user) => {
      if (!user) { location.href = 'index.html'; return; }
      currentUser = user;
      // fetch profile
      const usersCol = collection(db, 'users');
      const q = query(usersCol, where('uid', '==', user.uid));
      const snap = await (await import('https://www.gstatic.com/firebasejs/10.13.1/firebase-firestore.js')).getDocs(q);
      const profileDoc = snap.docs[0];
      if (!profileDoc) {
        alert('Profile missing. Please sign in again.');
        await signOut(auth);
        location.href = 'index.html';
        return;
      }
      myProfile = profileDoc.data();
      if (myProfile.role !== 'worker') {
        alert('Redirecting to client dashboard.');
        location.href = 'client.html';
        return;
      }
      workerNameEl.textContent = myProfile.name || myProfile.email;
      startListeners();
    });

    function startListeners() {
      if (unsubAvailable) unsubAvailable();
      if (unsubAccepted) unsubAccepted();

      const jobsCol = collection(db, 'jobs');
      const availableQ = query(jobsCol, where('status', '==', 'open'), orderBy('createdAt', 'desc'));
      unsubAvailable = onSnapshot(availableQ, (snap) => {
        jobsGrid.innerHTML = '';
        snap.forEach(d => {
          const j = { id: d.id, ...d.data() };
          jobsGrid.appendChild(renderJobCard(j));
        });
      });

      const myAcceptedQ = query(collection(db, 'jobs'), where('acceptedBy', '==', currentUser.uid), orderBy('createdAt', 'desc'));
      unsubAccepted = onSnapshot(myAcceptedQ, (snap) => {
        acceptedList.innerHTML = '';
        snap.forEach(d => {
          const j = { id: d.id, ...d.data() };
          acceptedList.appendChild(renderAcceptedCard(j));
        });
      });
    }

    function renderJobCard(j) {
      const div = document.createElement('div');
      div.className = 'bg-white rounded-lg shadow p-4 cursor-pointer';
      div.innerHTML = `<div class="flex justify-between items-start gap-3">
          <div>
            <div class="font-semibold">${escapeHtml(j.title)}</div>
            <div class="muted text-sm">${escapeHtml(j.category)} • ${escapeHtml(j.location)}</div>
            <div class="mt-2 muted text-sm">${escapeHtml(j.description).slice(0,200)}</div>
          </div>
          <div class="text-sm muted">${j.status || 'open'}</div>
        </div>`;
      div.onclick = () => openJobModal(j);
      return div;
    }

    function renderAcceptedCard(j) {
      const div = document.createElement('div');
      div.className = 'bg-white rounded-lg shadow p-4 flex justify-between items-center';
      div.innerHTML = `<div>
          <div class="font-semibold">${escapeHtml(j.title)}</div>
          <div class="muted text-sm">${escapeHtml(j.location)} • ${escapeHtml(j.category)}</div>
          <div class="muted text-sm">Client: ${escapeHtml(j.clientId)}</div>
        </div>`;
      const actions = document.createElement('div');
      actions.className = 'flex flex-col gap-2 items-end';
      if (j.status !== 'completed') {
        const btnComplete = document.createElement('button');
        btnComplete.className = 'px-3 py-2 rounded bg-green-600 text-white text-sm';
        btnComplete.textContent = 'Mark Completed';
        btnComplete.onclick = async (ev) => {
          ev.stopPropagation();
          await updateDoc(doc(db, 'jobs', j.id), { status: 'completed', completedAt: new Date() });
        };
        actions.appendChild(btnComplete);
      } else {
        const done = document.createElement('div');
        done.className = 'text-sm bg-green-100 text-green-800 px-3 py-1 rounded';
        done.textContent = 'Completed';
        actions.appendChild(done);
      }
      div.appendChild(actions);
      return div;
    }

    function openJobModal(j) {
      chosenJob = j;
      modalTitle.textContent = j.title;
      modalBody.innerHTML = `<div class="muted text-sm mb-2">${escapeHtml(j.category)} • ${escapeHtml(j.location)}</div>
                             <div class="mb-2">${escapeHtml(j.description)}</div>
                             <div class="text-xs muted">Posted: ${new Date(j.createdAt?.toDate?.() || j.createdAt || Date.now()).toLocaleString()}</div>`;
      jobModal.classList.remove('hidden');
    }

    jobClose.onclick = () => jobModal.classList.add('hidden');
    jobCancel.onclick = () => jobModal.classList.add('hidden');

    jobAccept.onclick = async () => {
      if (!chosenJob) return;
      // Accept job: set acceptedBy, acceptedName, status -> 'accepted'
      try {
        await updateDoc(doc(db, 'jobs', chosenJob.id), {
          acceptedBy: currentUser.uid,
          acceptedName: myProfile.name || myProfile.email,
          status: 'accepted',
          acceptedAt: new Date()
        });
        alert('Job accepted. Please contact the client to coordinate.');
        jobModal.classList.add('hidden');
      } catch (e) {
        console.error(e);
        alert('Failed to accept job.');
      }
    };

    btnLogout.onclick = async () => {
      await signOut(auth);
      location.href = 'index.html';
    };

    btnAvailable.onclick = () => {
      // filter by selected category
      const cat = filterCategory.value;
      if (unsubAvailable) unsubAvailable();
      const jobsCol = collection(db, 'jobs');
      let q;
      if (cat) {
        q = query(jobsCol, where('status', '==', 'open'), where('category', '==', cat), orderBy('createdAt', 'desc'));
      } else {
        q = query(jobsCol, where('status', '==', 'open'), orderBy('createdAt', 'desc'));
      }
      unsubAvailable = onSnapshot(q, (snap) => {
        jobsGrid.innerHTML = '';
        snap.forEach(d => jobsGrid.appendChild(renderJobCard({ id: d.id, ...d.data() })));
      });
    };

    function escapeHtml(s) { return (s||'').toString().replace(/[&<>\"']/g, c => ({'&':'&amp;','<':'&lt;','>':'&gt;','\"':'&quot;',\"'\":\"&#39;\"})[c]); }
  </script>
</body>
</html>
